
# APT-GET-Vulnerability-exploit

## Motivation
The repository contains code that attempts to launch man-in-the middle attack on apt/apt-get

	* Advanced Package Tool, or APT can be described as a free software user interface to work with core libraries to handle various functionalities such as installation and removal of softwares on Debian and Linux distributions such as Ubuntu.
	* It automates the process of retrieval, configuration and installation of software packages.
	* Max Justicz ,a security researcher discovered Remote Code Execution(RCE) vulnerability named as CVE-2019-3462 in Linux Apt / apt-get on 22 Jan 2019. Using http it is possible for an attacker to redirect the download link of an installation package to a malicious server. 
	* The attacker can exploit vulnerability via man-in-the-middle attack and thereby executing code with root privileges also causing denial of service. 
	* Initially the exploit was discovered in version 1.4.8 or earlier. Now in most of the apt versions available today this serious vulnerability has been fixed and patched up.
	* Debian and Ubuntu use plain http repositories by default. Switch to HTTPS as a default in debian and other distributions is difficult as it requires maintaining valid TLS certificates on the mirror network, plus it is costly and depends on caching in low-bandwith environments.

## Working of APT:

<img src="Working-of-APT.PNG" width="500" height="500">

Following are the steps performed by APT:


**Step 1:** Parent process that interacts with user

**Step 2:** Parent forks off helper process to fetch data

**Step 3:** Parent process forks off /usr/lib/apt/methods/http

**Step 4:** Helper responds with "100 Capabilities" message.

**Step 5:** Parent process sends the apt configuration details("601 Configuration") and sends the URI of the requested package("600 URI acquire")

**Step 6:** Worker process communicates with the server and repeatedly updates the progress to the parent process ("102 Status" , "200 URI Start")

**Step 7:** Once the package has been acquired, the worker process sends a "201 URI done response"

## HTTP Redirect Request

If the resource is moved to a new URI location, the HTTP server responds with a 302 redirect message that contains the new URI location.
If the child process receives such a redirect message,it constructs 103 redirect message with the new URI and sends it to the parent process and dies.
The parent process then forks off http method again,now with the new URI.

<img src="HTTP-Redirect-Request.PNG" width="500" height="500">

## Vulnerability

The child process(http fetcher process) blindly decodes the location field and appends it to the "103 redirect message". Thus,the location string is vulnerable to attacks.
By performing man in the middle attack between the victim and the router, we can intercept the packets and modify the location string in the http redirect response
<img src="Vulnerability.PNG" width="500" height="500">

## Crafting attack payload
For instance,one can append a "200 URI done" message in the location string. Since the location field is not sanitized correctly,the parent process is fooled into the thinking the file has indeed been downloaded.
The parent process blindly believes the hashes mentioned in the URI done message and does not do any re-computation.
Further,in the Filename field we can specify the location of malicious file ,which has to be executed.
Thus,the malicious file is executed with root access.
<img src="Crafting-attack-payload.PNG" width="500" height="500">

### Requirements:
```
python2.7
scapy
netfilterqueue
```

### How to run:
1. In order to launch man-in-the middle attack run scapymitm.py
```
Usage :python scapymitm.py <interface> <vicitm-ip> <gateway-ip> 
```

2. Next run scapymanipulate.py to modify the http packets

3. Execute install.sh for apt operations


PS:Make sure you specify the correct interfaces in the code before running them!!!


